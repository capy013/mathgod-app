<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ç¥ MathGod - ç©©å®šåŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; }
        .card { background-color: #1e1e1e; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #333; }
        .btn-primary { background-color: #10b981; color: white; font-weight: bold; padding: 12px 20px; border-radius: 8px; width: 100%; transition: 0.2s; touch-action: manipulation; }
        .btn-primary:active { transform: scale(0.98); background-color: #059669; }
        .btn-secondary { background-color: #374151; color: white; padding: 10px 16px; border-radius: 8px; width: 100%; touch-action: manipulation; }
        .input-dark { background-color: #2d2d2d; border: 1px solid #444; color: white; padding: 12px; border-radius: 8px; width: 100%; outline: none; font-size: 16px; } /* font-size 16px prevents zoom on iOS */
        .input-dark:focus { border-color: #10b981; }
        .tag { display: inline-block; background: #374151; padding: 6px 12px; border-radius: 20px; font-size: 0.9em; margin-right: 6px; margin-bottom: 6px; cursor: pointer; border: 2px solid transparent; user-select: none; }
        .tag.selected { background: #064e3b; border-color: #10b981; color: #6ee7b7; }
        .bill-item { border-left: 4px solid #10b981; padding-left: 12px; margin-bottom: 12px; background: #262626; padding: 10px; border-radius: 0 8px 8px 0; }
        .sync-badge { font-size: 0.85em; padding: 4px 10px; border-radius: 20px; display: inline-flex; align-items: center; gap: 6px; transition: all 0.3s; }
        .status-online { background-color: #064e3b; color: #6ee7b7; border: 1px solid #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.3); }
        .status-offline { background-color: #374151; color: #9ca3af; border: 1px solid #4b5563; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto pb-24">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-emerald-400">æ•¸ç¥ MathGod</h1>
        <div id="syncStatus" class="sync-badge status-offline cursor-pointer" onclick="openSyncModal()">
            <span>âšª å–®æ©Ÿæ¨¡å¼</span>
        </div>
    </div>

    <div class="card">
        <h2 class="text-lg font-bold mb-3 flex justify-between items-center">
            ğŸ‘¥ åƒèˆ‡è€… <span id="userCount" class="text-sm font-normal text-gray-400">(0äºº)</span>
        </h2>
        <div class="flex gap-2 mb-3">
            <input type="text" id="newUserName" class="input-dark" placeholder="è¼¸å…¥äººå (ä¾‹: Jason)" onkeypress="handleEnter(event, addUser)">
            <button onclick="addUser()" class="bg-emerald-600 text-white px-5 rounded-lg font-bold text-xl leading-none pt-1 pb-1">+</button>
        </div>
        <div id="userList" class="flex flex-wrap gap-2">
            </div>
    </div>

    <div class="card">
        <h2 class="text-lg font-bold mb-3">ğŸ’¸ æ–°å¢å¸³å–®</h2>
        
        <div class="mb-3">
            <label class="text-xs text-gray-400 block mb-1">é …ç›®åç¨±</label>
            <input type="text" id="billDesc" class="input-dark" placeholder="ä¾‹: é£Ÿæ‹‰éºµ / Uber">
        </div>

        <div class="flex gap-3 mb-3">
            <div class="w-1/2">
                <label class="text-xs text-gray-400 block mb-1">é‡‘é¡ ($)</label>
                <input type="number" id="billAmount" class="input-dark" placeholder="0" inputmode="decimal">
            </div>
            <div class="w-1/2">
                <label class="text-xs text-gray-400 block mb-1">é‚Šå€‹ä¿¾éŒ¢?</label>
                <select id="payerSelect" class="input-dark bg-[#2d2d2d]">
                    <option value="" disabled selected>è«‹é¸æ“‡</option>
                </select>
            </div>
        </div>

        <div class="mb-3">
            <label class="text-xs text-gray-400 block mb-1">é‚Šå€‹æœ‰ä»½? (é»æ“Šé¸æ“‡ï¼Œç¶ è‰²=æœ‰ä»½)</label>
            <div id="consumerList" class="flex flex-wrap gap-2 mt-2 bg-gray-800 p-2 rounded border border-gray-700">
                <span class="text-gray-500 text-sm p-1">è«‹å…ˆæ–°å¢åƒèˆ‡è€…...</span>
            </div>
        </div>

        <button onclick="addBill()" class="btn-primary text-lg">ç¢ºèªè¨˜å¸³</button>
    </div>

    <div class="card" id="historySection" style="display:none;">
        <h2 class="text-lg font-bold mb-3">ğŸ“œ å¸³å–®ç´€éŒ„</h2>
        <div id="billList" class="text-sm text-gray-300 space-y-3">
            </div>
    </div>

    <div class="card">
        <h2 class="text-lg font-bold mb-3 flex justify-between items-center">
            ğŸ“Š çµç®—çµæœ
            <button onclick="copyResult()" class="text-xs bg-gray-700 px-3 py-1.5 rounded border border-gray-600 hover:bg-gray-600">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
        </h2>
        <div id="resultArea" class="space-y-2 text-sm">
            <p class="text-gray-500 text-center py-4">æš«æ™‚æœªæœ‰æ•¸</p>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-700 text-right flex justify-between items-center">
             <span class="text-gray-400 text-xs">ç¸½é–‹æ”¯</span>
             <span id="totalExpense" class="text-xl font-bold text-emerald-400">$0</span>
        </div>
    </div>

    <div class="text-center mt-8 mb-8 pb-10">
        <button onclick="resetAll()" class="text-red-400 text-xs underline px-4 py-2">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
    </div>

    <div id="syncModal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-sm border border-gray-600 shadow-2xl">
            <h3 class="text-xl font-bold mb-2 text-emerald-400">ğŸŒ åŒæ­¥æˆ¿é–“</h3>
            <p class="text-sm text-gray-400 mb-6">è¼¸å…¥ç›¸åŒçš„ 6 ä½æ•¸è™Ÿç¢¼ï¼Œå¤§å®¶å°±å¯ä»¥å³æ™‚åŒæ­¥ã€‚</p>
            
            <label class="text-xs text-gray-500 block mb-1">æˆ¿é–“è™Ÿç¢¼</label>
            <input type="tel" id="roomInput" class="input-dark mb-6 text-center text-2xl tracking-widest font-mono" placeholder="888888" maxlength="6">
            
            <button onclick="joinRoom()" class="btn-primary mb-3">é€²å…¥æˆ¿é–“</button>
            <button onclick="closeSyncModal()" class="btn-secondary text-gray-400">å–æ¶ˆ / å–®æ©Ÿç”¨ä½å…ˆ</button>
        </div>
    </div>

    <script>
        // 1. åˆå§‹åŒ–ç‹€æ…‹
        const appState = {
            users: [],
            bills: [],
            roomId: null,
            db: null
        };

        // 2. Firebase é…ç½® (è«‹åœ¨æ­¤å¡«å…¥ä½ çš„è³‡æ–™)
        // âš ï¸ å‹™å¿…æ›¿æ›é€™è£¡çš„ apiKey
        const firebaseConfig = {
            apiKey: "ä½ çš„_API_KEY_å¡«åœ¨é€™è£¡", 
            authDomain: "mathgod2.firebaseapp.com",
            databaseURL: "https://mathgod2-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "mathgod2",
            storageBucket: "mathgod2.appspot.com",
            messagingSenderId: "1056582522765",
            appId: "1:1056582522765:web:03f3938031d2003c40156d"
        };

        // 3. å˜—è©¦é€£æ¥ Firebase
        try {
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey !== "ä½ çš„_API_KEY_å¡«åœ¨é€™è£¡") {
                firebase.initializeApp(firebaseConfig);
                appState.db = firebase.database();
                console.log("Firebase é€£æ¥æˆåŠŸ");
            } else {
                console.warn("Firebase æœªé…ç½®æˆ–åº«æœªåŠ è¼‰ï¼Œå°‡é‹è¡Œæ–¼å–®æ©Ÿæ¨¡å¼");
            }
        } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("Firebase è¨­å®šæœ‰èª¤ï¼Œå·²åˆ‡æ›è‡³å–®æ©Ÿæ¨¡å¼ã€‚");
        }

        // 4. å•Ÿå‹•åŠ è¼‰
        loadLocalData();

        // --- æ ¸å¿ƒåŠŸèƒ½å‡½æ•¸ ---

        function handleEnter(e, func) {
            if (e.key === 'Enter') func();
        }

        function addUser() {
            const nameInput = document.getElementById('newUserName');
            const name = nameInput.value.trim();
            if (!name) return;
            
            if (appState.users.includes(name)) {
                alert("å€‹åæ’å’—å•¦ï¼Œè©¦ä¸‹ç¬¬äºŒå€‹ï¼");
                return;
            }

            appState.users.push(name);
            nameInput.value = '';
            
            saveData(); // å­˜æª”
            renderUI(); // æ›´æ–°ç•«é¢
        }

        function toggleConsumer(name, btn) {
            btn.classList.toggle('selected');
        }

        function addBill() {
            // ç²å–è¼¸å…¥
            const descInput = document.getElementById('billDesc');
            const amountInput = document.getElementById('billAmount');
            const payerSelect = document.getElementById('payerSelect');
            
            const desc = descInput.value.trim() || "æœªåˆ†é¡é …ç›®";
            const amount = parseFloat(amountInput.value);
            const payer = payerSelect.value;
            
            // ç²å–é¸ä¸­çš„æ¶ˆè²»è€…
            const consumerBtns = document.querySelectorAll('#consumerList .tag.selected');
            const consumers = Array.from(consumerBtns).map(btn => btn.getAttribute('data-name'));

            // é©—è­‰
            if (isNaN(amount) || amount <= 0) { alert("é‡‘é¡è¼¸å…¥éŒ¯èª¤ï¼"); return; }
            if (!payer) { alert("é‚Šå€‹ä¿¾éŒ¢å‘€ï¼Ÿ"); return; }
            if (consumers.length === 0) { alert("å†‡äººæœ‰ä»½ï¼Ÿè«‹é»é¸ä¸‹æ–¹äººå"); return; }

            const newBill = {
                id: Date.now(), // Unique ID
                desc: desc,
                amount: amount,
                payer: payer,
                consumers: consumers,
                date: new Date().toLocaleString('zh-HK', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'})
            };

            // æ›´æ–°æ•¸æ“š
            appState.bills.push(newBill);
            
            // æ¸…ç©ºè¼¸å…¥æ¡†
            descInput.value = '';
            amountInput.value = '';
            // é‡ç½®æ¶ˆè²»è€…é¸æ“‡ç‚ºå…¨é¸
            renderConsumers(true); 

            saveData();
            renderUI();
            
            // è¦–è¦ºåé¥‹
            alert("âœ… è¨˜å¸³æˆåŠŸï¼");
        }

        function deleteBill(id) {
            if(!confirm("ç¢ºå®šåˆªé™¤å‘¢æ¢æ•¸ï¼Ÿ")) return;
            appState.bills = appState.bills.filter(b => b.id !== id);
            saveData();
            renderUI();
        }

        function resetAll() {
            if (!confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ(å¦‚æœä¿‚åŒæ­¥æ¨¡å¼ï¼Œæœƒé€£é›²ç«¯ä¸€é½Šæ¸…)")) return;
            
            appState.users = [];
            appState.bills = [];
            
            // å¦‚æœé€£äº†ç·šï¼Œæ¸…ç©ºé›²ç«¯
            if (appState.roomId && appState.db) {
                appState.db.ref('rooms/' + appState.roomId).set({
                    users: [],
                    bills: [],
                    lastUpdate: Date.now()
                });
            }
            
            appState.roomId = null;
            updateSyncStatus(false);
            
            saveData();
            renderUI();
            
            // é‡è¼‰é é¢ç¢ºä¿ä¹¾æ·¨
            setTimeout(() => location.reload(), 500);
        }

        // --- åŒæ­¥é‚è¼¯ (Sync) ---

        function openSyncModal() {
            document.getElementById('syncModal').classList.remove('hidden');
            document.getElementById('roomInput').focus();
        }

        function closeSyncModal() {
            document.getElementById('syncModal').classList.add('hidden');
        }

        function joinRoom() {
            if (!appState.db) {
                alert("Firebase æœªè¨­å®šå¥½ (API Key ç¼ºå¤±)ï¼Œåªèƒ½ç”¨å–®æ©Ÿç‰ˆã€‚");
                closeSyncModal();
                return;
            }

            const roomCode = document.getElementById('roomInput').value.trim();
            if (!roomCode || roomCode.length < 3) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆ¿é–“è™Ÿç¢¼");
                return;
            }

            appState.roomId = roomCode;
            closeSyncModal();
            updateSyncStatus(true, roomCode);

            // ç›£è½ Firebase æ•¸æ“šè®ŠåŒ–
            const roomRef = appState.db.ref('rooms/' + roomCode);
            
            roomRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // å¦‚æœé›²ç«¯æœ‰æ•¸æ“šï¼Œè¦†è“‹æœ¬åœ° (é™¤äº†ç•¶æ˜¯å‰›å‰µå»ºæ™‚)
                    appState.users = data.users || [];
                    appState.bills = data.bills || [];
                    console.log("é›²ç«¯åŒæ­¥æ›´æ–°:", data);
                    renderUI(false); // é€™è£¡ä¸èª¿ç”¨ saveData é¿å…æ­»å¾ªç’°
                    
                    // åŒæ­¥åˆ°æœ¬åœ°å‚™ä»½
                    localStorage.setItem('mathGodData', JSON.stringify({
                        users: appState.users,
                        bills: appState.bills
                    }));
                } else {
                    // å¦‚æœé›²ç«¯æ˜¯ç©ºçš„ï¼ˆæ–°æˆ¿é–“ï¼‰ï¼ŒæŠŠæœ¬åœ°æ•¸æ“šæ¨ä¸Šå»
                    saveData();
                }
            });
        }

        function saveData() {
            // 1. å­˜æœ¬åœ°
            localStorage.setItem('mathGodData', JSON.stringify({
                users: appState.users,
                bills: appState.bills
            }));

            // 2. å­˜é›²ç«¯ (å¦‚æœå·²é€£ç·š)
            if (appState.roomId && appState.db) {
                appState.db.ref('rooms/' + appState.roomId).set({
                    users: appState.users,
                    bills: appState.bills,
                    lastUpdate: Date.now()
                }).catch(err => console.error("åŒæ­¥å¤±æ•—:", err));
            }
        }

        function loadLocalData() {
            const stored = localStorage.getItem('mathGodData');
            if (stored) {
                try {
                    const data = JSON.parse(stored);
                    appState.users = data.users || [];
                    appState.bills = data.bills || [];
                    renderUI();
                } catch(e) {
                    console.error("è®€å–èˆŠæ•¸æ“šå¤±æ•—", e);
                }
            }
        }

        // --- ç•«é¢æ¸²æŸ“ & è¨ˆç®— ---

        function renderUI(shouldSave = false) {
            renderUsers();
            renderConsumers(false); // false = don't reset selection, keep state if possible
            renderBills();
            calculateDebts();
            if (shouldSave) saveData();
        }

        function updateSyncStatus(isOnline, code) {
            const statusDiv = document.getElementById('syncStatus');
            if (isOnline) {
                statusDiv.className = 'sync-badge status-online cursor-pointer';
                statusDiv.innerHTML = `<span>ğŸŸ¢ æˆ¿é–“: ${code}</span>`;
            } else {
                statusDiv.className = 'sync-badge status-offline cursor-pointer';
                statusDiv.innerHTML = `<span>âšª å–®æ©Ÿæ¨¡å¼ (é»æ“Šé€£ç·š)</span>`;
            }
        }

        function renderUsers() {
            const list = document.getElementById('userList');
            const select = document.getElementById('payerSelect');
            const currentPayer = select.value;

            if (appState.users.length === 0) {
                list.innerHTML = '<span class="text-gray-500 text-sm">æš«ç„¡åƒèˆ‡è€…</span>';
            } else {
                list.innerHTML = appState.users.map(u => 
                    `<span class="tag cursor-default text-gray-300 bg-gray-700">${u}</span>`
                ).join('');
            }
            
            document.getElementById('userCount').innerText = `(${appState.users.length}äºº)`;

            // æ›´æ–°ä»˜æ¬¾äººä¸‹æ‹‰é¸å–®
            select.innerHTML = '<option value="" disabled>è«‹é¸æ“‡</option>';
            appState.users.forEach(u => {
                const option = document.createElement('option');
                option.value = u;
                option.innerText = u;
                if(u === currentPayer) option.selected = true;
                select.appendChild(option);
            });
        }

        function renderConsumers(reset = false) {
            const container = document.getElementById('consumerList');
            
            if (appState.users.length === 0) {
                container.innerHTML = '<span class="text-gray-500 text-sm p-1">è«‹å…ˆæ–°å¢åƒèˆ‡è€…...</span>';
                return;
            }

            // è¨˜ä½ç•¶å‰é¸ä¸­çš„äºº (å¦‚æœæ˜¯é‡ç¹ªè€Œä¸æ˜¯é‡ç½®)
            let currentSelected = [];
            if (!reset) {
                document.querySelectorAll('#consumerList .tag.selected').forEach(el => {
                    currentSelected.push(el.getAttribute('data-name'));
                });
            }
            
            container.innerHTML = appState.users.map(u => {
                // å¦‚æœæ˜¯é‡ç½®(æ–°å–®)ï¼Œé è¨­å…¨é¸ï¼›å¦å‰‡ä¿æŒä¹‹å‰çš„é¸æ“‡ç‹€æ…‹
                // è‹¥ä¹‹å‰ç„¡é¸æ“‡ç´€éŒ„ï¼ˆä¾‹å¦‚å‰›åŠ äººï¼‰ï¼Œé è¨­ç‚ºé¸ä¸­
                let isSelected = reset ? true : (currentSelected.length > 0 ? currentSelected.includes(u) : true);
                
                return `<div class="tag ${isSelected ? 'selected' : ''}" data-name="${u}" onclick="toggleConsumer('${u}', this)">${u}</div>`;
            }).join('');
        }

        function renderBills() {
            const list = document.getElementById('billList');
            const section = document.getElementById('historySection');
            
            if (appState.bills.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            list.innerHTML = appState.bills.slice().reverse().map(b => `
                <div class="bill-item flex justify-between items-start">
                    <div>
                        <div class="font-bold text-emerald-400 text-base">${b.desc}</div>
                        <div class="text-xs text-gray-300 mt-1">
                            <span class="text-emerald-200 font-bold">${b.payer}</span> ä¿¾ <span class="font-bold text-white">$${b.amount}</span>
                        </div> 
                        <div class="text-xs text-gray-500 mt-1">(${b.consumers.length}äººåˆ†: ${b.consumers.join(', ')})</div>
                        <div class="text-[10px] text-gray-600 mt-1">${b.date}</div>
                    </div>
                    <button onclick="deleteBill(${b.id})" class="text-gray-500 hover:text-red-400 px-3 py-2 text-lg">âœ•</button>
                </div>
            `).join('');
            
            // Update Total
            const total = appState.bills.reduce((sum, b) => sum + b.amount, 0);
            document.getElementById('totalExpense').innerText = `$${total.toFixed(1)}`;
        }

        function calculateDebts() {
            const balances = {};
            appState.users.forEach(u => balances[u] = 0);

            appState.bills.forEach(bill => {
                const amount = bill.amount;
                const payer = bill.payer;
                const consumers = bill.consumers;
                
                if (consumers.length > 0) {
                    const splitAmount = amount / consumers.length;
                    
                    if (balances[payer] !== undefined) balances[payer] += amount;

                    consumers.forEach(c => {
                        if (balances[c] !== undefined) balances[c] -= splitAmount;
                    });
                }
            });

            const resultArea = document.getElementById('resultArea');
            const debtors = [];
            const creditors = [];

            for (const [user, amount] of Object.entries(balances)) {
                if (amount < -0.01) debtors.push({ user, amount }); 
                else if (amount > 0.01) creditors.push({ user, amount }); 
            }

            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            const transactions = [];
            let i = 0; 
            let j = 0; 

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];

                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                amount = Math.round(amount * 10) / 10;

                if (amount > 0) {
                    transactions.push(`${debtor.user} ä¿¾ ${creditor.user} $${amount}`);
                }

                debtor.amount += amount;
                creditor.amount -= amount;

                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            if (transactions.length === 0) {
                resultArea.innerHTML = '<div class="text-center text-gray-500 py-2">ç›®å‰æ²’æœ‰éœ€è¦æ‰¾è´–çš„æ•¸ã€‚</div>';
            } else {
                resultArea.innerHTML = transactions.map(t => 
                    `<div class="bg-gray-800 p-3 rounded border-l-4 border-yellow-500 text-white font-mono text-sm shadow">${t}</div>`
                ).join('');
            }
            
            return transactions;
        }

        function copyResult() {
            const tx = calculateDebts();
            if (!tx || tx.length === 0) { alert("å†‡æ•¸è¦è¤‡è£½ï¼"); return; }
            
            const total = document.getElementById('totalExpense').innerText;
            const text = `ğŸ’° æ•¸ç¥ MathGod çµç®—:\n\n${tx.join('\n')}\n\nç¸½é–‹æ”¯: ${total}`;
            
            // å…¼å®¹æ‰‹æ©Ÿè¤‡è£½
            const textarea = document.createElement("textarea");
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand("copy");
                alert("âœ… å·²è¤‡è£½çµæœï¼å¯ä»¥å» WhatsApp è²¼ä¸Šå•¦ã€‚");
            } catch (err) {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹• Cap åœ–ã€‚");
            }
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>
