<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸ç¥ MathGod - åŒæ­¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; }
        .card { background-color: #1e1e1e; border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid #333; }
        .btn-primary { background-color: #10b981; color: white; font-weight: bold; padding: 10px 20px; border-radius: 8px; width: 100%; transition: 0.2s; }
        .btn-primary:active { transform: scale(0.98); background-color: #059669; }
        .btn-secondary { background-color: #374151; color: white; padding: 8px 16px; border-radius: 8px; width: 100%; }
        .input-dark { background-color: #2d2d2d; border: 1px solid #444; color: white; padding: 10px; border-radius: 8px; width: 100%; outline: none; }
        .input-dark:focus { border-color: #10b981; }
        .tag { display: inline-block; background: #374151; padding: 4px 10px; border-radius: 16px; font-size: 0.9em; margin-right: 5px; margin-bottom: 5px; cursor: pointer; border: 1px solid transparent; }
        .tag.selected { background: #065f46; border-color: #10b981; color: #a7f3d0; }
        .bill-item { border-left: 4px solid #10b981; padding-left: 10px; margin-bottom: 10px; }
        .sync-badge { font-size: 0.8em; padding: 2px 8px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px; }
        .status-online { background-color: #064e3b; color: #6ee7b7; border: 1px solid #10b981; }
        .status-offline { background-color: #374151; color: #9ca3af; border: 1px solid #4b5563; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto pb-20">

    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold text-emerald-400">æ•¸ç¥ MathGod</h1>
        <div id="syncStatus" class="sync-badge status-offline cursor-pointer" onclick="openSyncModal()">
            <span>âšª å–®æ©Ÿæ¨¡å¼</span>
        </div>
    </div>

    <div class="card">
        <h2 class="text-lg font-bold mb-3 flex justify-between">
            ğŸ‘¥ åƒèˆ‡è€… <span id="userCount" class="text-sm font-normal text-gray-400">(0äºº)</span>
        </h2>
        <div class="flex gap-2 mb-3">
            <input type="text" id="newUserName" class="input-dark" placeholder="è¼¸å…¥å (ä¾‹: Jacky)" onkeypress="handleEnter(event, addUser)">
            <button onclick="addUser()" class="bg-emerald-600 text-white px-4 rounded-lg font-bold">+</button>
        </div>
        <div id="userList" class="flex flex-wrap gap-2">
            </div>
    </div>

    <div class="card">
        <h2 class="text-lg font-bold mb-3">ğŸ’¸ æ–°å¢å¸³å–®</h2>
        
        <div class="mb-3">
            <label class="text-xs text-gray-400 block mb-1">æ´»å‹•/é …ç›®åç¨±</label>
            <input type="text" id="billDesc" class="input-dark" placeholder="ä¾‹: é£Ÿæ‹‰éºµ / Uber">
        </div>

        <div class="flex gap-3 mb-3">
            <div class="w-1/2">
                <label class="text-xs text-gray-400 block mb-1">é‡‘é¡ ($)</label>
                <input type="number" id="billAmount" class="input-dark" placeholder="0">
            </div>
            <div class="w-1/2">
                <label class="text-xs text-gray-400 block mb-1">é‚Šå€‹ä¿¾éŒ¢?</label>
                <select id="payerSelect" class="input-dark">
                    <option value="" disabled selected>è«‹é¸æ“‡</option>
                </select>
            </div>
        </div>

        <div class="mb-3">
            <label class="text-xs text-gray-400 block mb-1">é‚Šå€‹æœ‰ä»½? (é»æ“Šé¸æ“‡ï¼Œé è¨­å…¨é¸)</label>
            <div id="consumerList" class="flex flex-wrap gap-2 mt-2">
                </div>
        </div>

        <button onclick="addBill()" class="btn-primary">ç¢ºèªè¨˜å¸³</button>
    </div>

    <div class="card" id="historySection" style="display:none;">
        <h2 class="text-lg font-bold mb-3">ğŸ“œ å¸³å–®ç´€éŒ„</h2>
        <div id="billList" class="text-sm text-gray-300 space-y-3">
            </div>
    </div>

    <div class="card">
        <h2 class="text-lg font-bold mb-3 flex justify-between items-center">
            ğŸ“Š çµç®—çµæœ
            <button onclick="copyResult()" class="text-xs bg-gray-700 px-2 py-1 rounded border border-gray-600">ğŸ“‹ è¤‡è£½æ–‡å­—</button>
        </h2>
        <div id="resultArea" class="space-y-2 text-sm">
            <p class="text-gray-500 text-center py-4">æš«æ™‚æœªæœ‰æ•¸</p>
        </div>
        <div class="mt-4 pt-4 border-t border-gray-700 text-right">
             <span class="text-gray-400 text-xs">ç¸½é–‹æ”¯: </span>
             <span id="totalExpense" class="text-xl font-bold text-emerald-400">$0</span>
        </div>
    </div>

    <div class="text-center mt-8 mb-8">
        <button onclick="resetAll()" class="text-red-400 text-xs underline">âš ï¸ é‡ç½®æ‰€æœ‰è³‡æ–™</button>
    </div>

    <div id="syncModal" class="fixed inset-0 bg-black bg-opacity-90 hidden flex items-center justify-center z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-11/12 max-w-sm border border-gray-700">
            <h3 class="text-xl font-bold mb-4 text-emerald-400">ğŸŒ åŒæ­¥æˆ¿é–“</h3>
            <p class="text-sm text-gray-400 mb-4">è¼¸å…¥ç›¸åŒçš„æˆ¿é–“è™Ÿç¢¼ï¼Œå¤§å®¶å°±å¯ä»¥å³æ™‚ä¸€é½Šè¨˜å¸³ã€‚</p>
            <input type="text" id="roomInput" class="input-dark mb-4 text-center text-xl tracking-widest" placeholder="ä¾‹å¦‚: 888888">
            <button onclick="joinRoom()" class="btn-primary mb-3">é€²å…¥æˆ¿é–“</button>
            <button onclick="closeSyncModal()" class="btn-secondary">å–æ¶ˆ / å–®æ©Ÿç”¨ä½å…ˆ</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ğŸ”´ è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ Firebase è³‡æ–™
        const firebaseConfig = {
            apiKey: "è«‹å¡«å…¥ä½ çš„API_KEY", // <--- é€™è£¡ï¼
            authDomain: "mathgod2.firebaseapp.com",
            databaseURL: "https://mathgod2-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "mathgod2",
            storageBucket: "mathgod2.appspot.com",
            messagingSenderId: "1056582522765",
            appId: "1:1056582522765:web:03f3938031d2003c40156d"
        };

        // Initialize Firebase
        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            console.log("Firebase initialized");
        } catch (e) {
            console.error("Firebase init error (check API Key):", e);
        }

        // Global State
        window.appState = {
            users: [],
            bills: [],
            roomId: null
        };

        // Expose functions to window for HTML onclick events
        window.addUser = addUser;
        window.addBill = addBill;
        window.deleteBill = deleteBill;
        window.resetAll = resetAll;
        window.openSyncModal = openSyncModal;
        window.closeSyncModal = closeSyncModal;
        window.joinRoom = joinRoom;
        window.copyResult = copyResult;
        window.toggleConsumer = toggleConsumer;
        window.handleEnter = handleEnter;

        // Load Local Data on Start
        loadLocalData();

        // --- Core Functions ---

        function handleEnter(e, func) {
            if (e.key === 'Enter') func();
        }

        function addUser() {
            const nameInput = document.getElementById('newUserName');
            const name = nameInput.value.trim();
            if (!name) return;
            
            if (window.appState.users.includes(name)) {
                alert("å€‹åæ’å’—å•¦ï¼Œè©¦ä¸‹ç¬¬äºŒå€‹ï¼");
                return;
            }

            window.appState.users.push(name);
            nameInput.value = '';
            saveData();
            renderUI();
        }

        function toggleConsumer(name, btn) {
            btn.classList.toggle('selected');
        }

        function addBill() {
            const desc = document.getElementById('billDesc').value.trim() || "æœªåˆ†é¡é …ç›®";
            const amount = parseFloat(document.getElementById('billAmount').value);
            const payer = document.getElementById('payerSelect').value;
            
            // Get selected consumers
            const consumerBtns = document.querySelectorAll('#consumerList .tag.selected');
            const consumers = Array.from(consumerBtns).map(btn => btn.innerText);

            if (!amount || amount <= 0) { alert("é‡‘é¡å””å•±å–ï¼"); return; }
            if (!payer) { alert("é‚Šå€‹ä¿¾éŒ¢å‘€ï¼Ÿ"); return; }
            if (consumers.length === 0) { alert("å†‡äººæœ‰ä»½ï¼Ÿ"); return; }

            const newBill = {
                id: Date.now(),
                desc,
                amount,
                payer,
                consumers,
                date: new Date().toLocaleString('zh-HK', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit'})
            };

            window.appState.bills.push(newBill);
            
            // Clear inputs
            document.getElementById('billDesc').value = '';
            document.getElementById('billAmount').value = '';
            // Reset consumers to all selected
            renderConsumers(true); 

            saveData();
            renderUI();
        }

        function deleteBill(id) {
            if(!confirm("ç¢ºå®šåˆªé™¤å‘¢æ¢æ•¸ï¼Ÿ")) return;
            window.appState.bills = window.appState.bills.filter(b => b.id !== id);
            saveData();
            renderUI();
        }

        function resetAll() {
            if (!confirm("âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿä¸èƒ½å¾©åŸï¼")) return;
            window.appState.users = [];
            window.appState.bills = [];
            
            if (window.appState.roomId) {
                // If online, clear DB
                set(ref(db, 'rooms/' + window.appState.roomId), {
                    users: [],
                    bills: [],
                    lastUpdate: Date.now()
                });
            }
            
            saveData();
            renderUI();
        }

        // --- Sync Logic ---

        function openSyncModal() {
            document.getElementById('syncModal').classList.remove('hidden');
        }

        function closeSyncModal() {
            document.getElementById('syncModal').classList.add('hidden');
        }

        function joinRoom() {
            const roomCode = document.getElementById('roomInput').value.trim();
            if (!roomCode || roomCode.length < 3) {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„æˆ¿é–“è™Ÿç¢¼");
                return;
            }

            window.appState.roomId = roomCode;
            closeSyncModal();
            updateSyncStatus(true, roomCode);

            // Listen to Firebase
            const roomRef = ref(db, 'rooms/' + roomCode);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    window.appState.users = data.users || [];
                    window.appState.bills = data.bills || [];
                    console.log("Synced from cloud:", data);
                    renderUI(); // Render but don't save to loop
                } else {
                    // New room, push local data up
                    saveData(); 
                }
            });
        }

        function saveData() {
            // 1. Save Local
            localStorage.setItem('mathGodData', JSON.stringify({
                users: window.appState.users,
                bills: window.appState.bills
            }));

            // 2. Save Cloud (if connected)
            if (window.appState.roomId && db) {
                set(ref(db, 'rooms/' + window.appState.roomId), {
                    users: window.appState.users,
                    bills: window.appState.bills,
                    lastUpdate: Date.now()
                });
            }
        }

        function loadLocalData() {
            const stored = localStorage.getItem('mathGodData');
            if (stored) {
                const data = JSON.parse(stored);
                window.appState.users = data.users || [];
                window.appState.bills = data.bills || [];
                renderUI();
            }
        }

        // --- Rendering & Calculation ---

        function renderUI() {
            renderUsers();
            renderConsumers(); 
            renderBills();
            calculateDebts();
        }

        function updateSyncStatus(isOnline, code) {
            const statusDiv = document.getElementById('syncStatus');
            if (isOnline) {
                statusDiv.className = 'sync-badge status-online cursor-pointer';
                statusDiv.innerHTML = `<span>ğŸŸ¢ æˆ¿é–“: ${code}</span>`;
            } else {
                statusDiv.className = 'sync-badge status-offline cursor-pointer';
                statusDiv.innerHTML = `<span>âšª å–®æ©Ÿæ¨¡å¼</span>`;
            }
        }

        function renderUsers() {
            const list = document.getElementById('userList');
            const select = document.getElementById('payerSelect');
            const currentPayer = select.value;

            list.innerHTML = window.appState.users.map(u => 
                `<span class="tag cursor-default text-gray-300 bg-gray-700">${u}</span>`
            ).join('');
            
            document.getElementById('userCount').innerText = `(${window.appState.users.length}äºº)`;

            // Update Payer Select
            select.innerHTML = '<option value="" disabled>è«‹é¸æ“‡</option>';
            window.appState.users.forEach(u => {
                const option = document.createElement('option');
                option.value = u;
                option.innerText = u;
                if(u === currentPayer) option.selected = true;
                select.appendChild(option);
            });
        }

        function renderConsumers(reset = false) {
            const container = document.getElementById('consumerList');
            // If checking existing state vs reset
            let currentSelected = [];
            if (!reset) {
                document.querySelectorAll('#consumerList .tag.selected').forEach(el => currentSelected.push(el.innerText));
            }
            
            container.innerHTML = window.appState.users.map(u => {
                // If reset (new bill) or previously selected, mark as selected
                const isSelected = reset || currentSelected.includes(u) || currentSelected.length === 0; 
                return `<div class="tag ${isSelected ? 'selected' : ''}" onclick="toggleConsumer('${u}', this)">${u}</div>`;
            }).join('');
        }

        function renderBills() {
            const list = document.getElementById('billList');
            const section = document.getElementById('historySection');
            
            if (window.appState.bills.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';

            list.innerHTML = window.appState.bills.slice().reverse().map(b => `
                <div class="bill-item bg-gray-800 rounded p-2 flex justify-between items-start">
                    <div>
                        <div class="font-bold text-emerald-400">${b.desc}</div>
                        <div class="text-xs text-gray-400">${b.payer} ä¿¾ $${b.amount} (for ${b.consumers.length}äºº)</div>
                        <div class="text-xs text-gray-500 mt-1">${b.date}</div>
                    </div>
                    <button onclick="deleteBill(${b.id})" class="text-gray-500 hover:text-red-400 px-2">âœ•</button>
                </div>
            `).join('');
            
            // Update Total
            const total = window.appState.bills.reduce((sum, b) => sum + b.amount, 0);
            document.getElementById('totalExpense').innerText = `$${total.toFixed(1)}`;
        }

        function calculateDebts() {
            const balances = {};
            window.appState.users.forEach(u => balances[u] = 0);

            window.appState.bills.forEach(bill => {
                const amount = bill.amount;
                const payer = bill.payer;
                const consumers = bill.consumers;
                
                if (consumers.length > 0) {
                    const splitAmount = amount / consumers.length;
                    
                    // Payer gets positive balance (paid more)
                    if (balances[payer] !== undefined) balances[payer] += amount;

                    // Consumers get negative balance (consumed value)
                    consumers.forEach(c => {
                        if (balances[c] !== undefined) balances[c] -= splitAmount;
                    });
                }
            });

            // Display Logic
            const resultArea = document.getElementById('resultArea');
            let html = '';
            const debtors = [];
            const creditors = [];

            // Sort into who owes and who is owed
            for (const [user, amount] of Object.entries(balances)) {
                if (amount < -0.01) debtors.push({ user, amount }); // Owes money
                else if (amount > 0.01) creditors.push({ user, amount }); // Is owed money
            }

            debtors.sort((a, b) => a.amount - b.amount);
            creditors.sort((a, b) => b.amount - a.amount);

            const transactions = [];

            // Settlement Algorithm
            let i = 0; // debtor index
            let j = 0; // creditor index

            while (i < debtors.length && j < creditors.length) {
                let debtor = debtors[i];
                let creditor = creditors[j];

                let amount = Math.min(Math.abs(debtor.amount), creditor.amount);
                
                // Round to 1 decimal place to avoid 0.0000001 issues
                amount = Math.round(amount * 10) / 10;

                if (amount > 0) {
                    transactions.push(`${debtor.user} ä¿¾ ${creditor.user} $${amount}`);
                }

                debtor.amount += amount;
                creditor.amount -= amount;

                if (Math.abs(debtor.amount) < 0.01) i++;
                if (creditor.amount < 0.01) j++;
            }

            if (transactions.length === 0) {
                resultArea.innerHTML = '<div class="text-center text-gray-500 py-2">ç›®å‰æ²’æœ‰éœ€è¦æ‰¾è´–çš„æ•¸ã€‚</div>';
            } else {
                resultArea.innerHTML = transactions.map(t => 
                    `<div class="bg-gray-800 p-2 rounded border-l-4 border-yellow-500 text-white">${t}</div>`
                ).join('');
            }
            
            return transactions;
        }

        function copyResult() {
            const tx = calculateDebts();
            if (tx.length === 0) { alert("å†‡æ•¸è¦è¤‡è£½ï¼"); return; }
            
            const total = document.getElementById('totalExpense').innerText;
            const text = `ğŸ’° æ•¸ç¥ MathGod çµç®—:\n\n${tx.join('\n')}\n\nç¸½é–‹æ”¯: ${total}\n(Link: ${window.location.href})`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert("å·²è¤‡è£½çµæœï¼å¯ä»¥å» WhatsAppè²¼ä¸Šå•¦ã€‚");
            }).catch(err => {
                console.error('Copy failed', err);
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹äººæ‰‹ Cap åœ–ã€‚");
            });
        }

    </script>
</body>
</html>
